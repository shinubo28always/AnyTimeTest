<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Metadata Editor - Final Fix</title>
<style>
  body { background: #0d0d0d; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; text-align: center; }
  h1 { margin-bottom: 20px; color: #00eaff; }
  .container { background: #1a1a1a; padding: 20px; border-radius: 12px; max-width: 450px; margin: auto; box-shadow: 0 4px 15px rgba(0, 234, 255, 0.1); }
  input, button { width: 95%; padding: 12px; margin: 8px 0; font-size: 16px; border-radius: 6px; border: 1px solid #333; background: #222; color: #fff; }
  input::placeholder { color: #888; }
  input[type="file"] { padding: 10px; background: #333; }
  button { background: #00eaff; color: #000; cursor: pointer; font-weight: bold; border: none; transition: background 0.3s; }
  button:hover:not(:disabled) { background: #00c4d4; }
  button:disabled { background: #555; cursor: not-allowed; }
  #statusBox, #logBox { background: #111; padding: 15px; margin-top: 20px; border-radius: 10px; text-align: left; font-size: 14px; border: 1px solid #222; }
  #logBox { height: 150px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; line-height: 1.5; white-space: pre-wrap; }
  #progressBarContainer { height: 10px; background: #333; border-radius: 5px; margin-top: 10px; overflow: hidden; }
  #progressBar { width: 0%; height: 100%; background: #00eaff; transition: width 0.2s; }
</style>
</head>
<body>

<h1>ðŸŽ¬ Video Metadata Editor</h1>

<div class="container">
  <input type="file" id="fileInput" accept="video/*">
  <input type="text" id="title" placeholder="Title (e.g., My Awesome Video)">
  <input type="text" id="author" placeholder="Author / Artist (e.g., John Doe)">
  <input type="text" id="album" placeholder="Album / Show (e.g., Holiday Clips)">
  <input type="text" id="encodedBy" placeholder="Encoded By (e.g., My Encoder)">
  <input type="text" id="comment" placeholder="Comment (e.g., 4K Remaster)">
  <button id="startBtn">Apply Metadata</button>
</div>

<div id="statusBox">
  <b>Status:</b> <span id="statusText">Waiting for FFmpeg to load...</span>
  <div id="progressBarContainer">
    <div id="progressBar"></div>
  </div>
</div>

<div id="logBox">Logs will appear here...</div>

<script type="module">
  import { FFmpeg } from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/esm/index.js";
  import { toBlobURL } from "https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.js";

  const ffmpeg = new FFmpeg();
  const logBox = document.getElementById("logBox");
  const statusText = document.getElementById("statusText");
  const progressBar = document.getElementById("progressBar");
  const startBtn = document.getElementById("startBtn");

  const log = (message) => {
    logBox.textContent += `> ${message}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  };

  const loadFFmpeg = async () => {
    try {
      startBtn.disabled = true;
      statusText.textContent = 'Loading FFmpeg Core...';
      log('Loading FFmpeg...');
      
      const ffmpegURL = "https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/esm";
      const coreURL = "https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm";

      ffmpeg.on("log", ({ message }) => log(message));
      
      // *** Ei shomosto loading part-ti ekhon 100% shothik ***
      await ffmpeg.load({
        coreURL: await toBlobURL(`${coreURL}/ffmpeg-core.js`, "text/javascript"),
        wasmURL: await toBlobURL(`${coreURL}/ffmpeg-core.wasm`, "application/wasm"),
        // *** EI NOTUN LINE-TI ADD KORA HOYECHE ***
        workerURL: await toBlobURL(`${ffmpegURL}/worker.js`, "text/javascript"),
      });

      statusText.textContent = "Ready! Select a video.";
      log("FFmpeg loaded successfully!");
      startBtn.disabled = false;
    } catch (error) {
      statusText.textContent = "Failed to load FFmpeg. Check console for errors.";
      log(`Error loading FFmpeg: ${error}`);
      console.error(error);
    }
  };

  loadFFmpeg();

  ffmpeg.on("progress", ({ progress }) => {
    if (progress >= 0 && progress <= 1) {
      const percent = Math.round(progress * 100);
      progressBar.style.width = `${percent}%`;
      statusText.textContent = `Processing: ${percent}%`;
    }
  });

  startBtn.onclick = async () => {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    if (!file) {
      alert("Please select a video file first!");
      return;
    }

    startBtn.disabled = true;
    logBox.textContent = "Starting process...\n";
    progressBar.style.width = '0%';

    try {
      const inName = "input." + file.name.split('.').pop();
      const outName = `output_${Date.now()}.mp4`;

      log(`Input file: ${file.name}`);
      log("Writing file to FFmpeg's virtual memory...");
      statusText.textContent = "Uploading file to memory...";
      
      await ffmpeg.writeFile(inName, new Uint8Array(await file.arrayBuffer()));
      log("File written successfully.");

      const metadataArgs = [];
      const addMeta = (key, value) => {
        if (value) metadataArgs.push("-metadata", `${key}=${value}`);
      };

      addMeta("title", document.getElementById("title").value);
      addMeta("artist", document.getElementById("author").value);
      addMeta("album", document.getElementById("album").value);
      addMeta("encoded_by", document.getElementById("encodedBy").value);
      addMeta("comment", document.getElementById("comment").value);

      log("Executing FFmpeg command...");
      
      await ffmpeg.exec([
        "-i", inName,
        ...metadataArgs,
        "-c", "copy",
        outName
      ]);

      log("Command executed. Reading output file...");
      statusText.textContent = "Finalizing...";

      const data = await ffmpeg.readFile(outName);
      const blob = new Blob([data.buffer], { type: "video/mp4" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = outName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      log(`Processing complete! File "${outName}" downloaded.`);
      statusText.textContent = "Done! Check your downloads.";

    } catch (error) {
      log(`An error occurred: ${error}`);
      statusText.textContent = "An error occurred. Check logs for details.";
      console.error(error);
    } finally {
      startBtn.disabled = false;
      progressBar.style.width = '0%';
    }
  };
</script>

</body>
</html>
